<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¡è·¯é‡Œæ¶ˆè€—è¨ˆç®—èˆ‡é«”é‡è¶¨å‹¢æ¨¡æ“¬å™¨</title>
    <!-- å¼•å…¥ Tailwind CSS é€²è¡Œå¿«é€Ÿã€éŸ¿æ‡‰å¼çš„ç¾è§€è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Chart.js ç¹ªåœ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- ADDED: å¼•å…¥ MathJax 3 for rendering LaTeX formulas in the modal -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* è¨­ç½®åŸºæœ¬å­—é«”å’ŒèƒŒæ™¯ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f9fb;
            min-height: 100vh;
            overflow-y: auto; 
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
        }
        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.25rem; 
            margin-bottom: 0.75rem; 
            border: 1px solid #e2e8f0;
        }
        /* æ¨™é¡Œé¡è‰² */
        .primary-color {
            color: #3b82f6; /* è—è‰² */
        }
        /* Slider æ¨£å¼ */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        /* Toggle Button Group */
        .toggle-group input:checked + label {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
        }
        .toggle-group label {
            transition: all 0.2s ease;
        }

        /* éŸ¿æ‡‰å¼ä½ˆå±€ï¼šç¢ºä¿åœ¨æ¡Œé¢ä¸Šæ•´å€‹å…§å®¹å€åŸŸå¡«æ»¿è¢å¹•é«˜åº¦ï¼Œä¸¦å•Ÿç”¨å…§éƒ¨æ²å‹• */
        @media (min-width: 1024px) {
            body {
                height: 100vh;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            #main-container {
                height: calc(100vh - 2rem); 
            }
            #main-layout {
                grid-template-columns: 1fr 1.5fr;
                flex-grow: 1;
                overflow: hidden; 
            }
        }
        /* RWD ä¿®æ­£ï¼šç¢ºä¿åœ¨æ‰‹æ©Ÿä¸Šæ»‘æ¡¿å€åŸŸæœ‰è¶³å¤ çš„é«˜åº¦ */
        @media (max-width: 767px) {
            .input-group-stack > div {
                margin-bottom: 1rem; /* å¢åŠ æ¯å€‹è¼¸å…¥å€åŸŸä¹‹é–“çš„é–“è· */
            }
        }
    </style>
</head>
<body class="p-4 lg:p-8">
    <div id="main-container" class="flex flex-col items-center min-h-screen w-full p-4 md:p-8 bg-[#f7f9fb] relative">
        <!-- ADDED: Technical Specs Button (Top Right) (Fix 2) -->
        <button id="open-specs-btn" class="absolute top-4 right-4 md:top-8 md:right-8 p-3 bg-white hover:bg-gray-100 text-[#4f46e5] rounded-full shadow-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-[#4f46e5] z-10" aria-label="Open Technical Specifications">
            <!-- Lucide book-open-text icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open-text"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/><path d="M6 8h2"/><path d="M6 12h2"/><path d="M16 12h2"/><path d="M16 8h2"/></svg>
        </button>
        
        <h1 class="text-3xl lg:text-4xl font-extrabold text-gray-800 mb-4 primary-color text-center flex-shrink-0">
            å¡è·¯é‡Œæ¶ˆè€—èˆ‡é«”é‡è¶¨å‹¢æ¨¡æ“¬å™¨
        </h1>

        <!-- ä¸»ä½ˆå±€å€ï¼šåœ¨æ‰‹æ©Ÿä¸Šè‡ªç„¶æµå‹•ï¼Œæ¡Œé¢ç«¯ä½”æ»¿å‰©é¤˜é«˜åº¦ -->
        <div id="main-layout" class="grid grid-cols-1 gap-4 lg:grid-cols-2 lg:flex-grow">

            <!-- å·¦å´è¼¸å…¥æ¬„ï¼šåœ¨æ¡Œé¢ç«¯æœƒå¡«æ»¿é«˜åº¦ -->
            <div class="flex flex-col space-y-4 lg:h-full lg:overflow-y-auto">>

                <!-- A. åŸºæœ¬æ¢ä»¶è¼¸å…¥ - å›ºå®šé«˜åº¦ -->
                <div id="input-bmc" class="card flex-shrink-0">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">A. åŸºæœ¬æ¢ä»¶èˆ‡é£²é£Ÿ</h2>

                    <!-- æ€§åˆ¥ -->
                    <div class="mb-4">
                        <label class="block text-gray-600 mb-1 font-medium text-sm">æ€§åˆ¥</label>
                        <div id="gender-group" class="toggle-group flex rounded-lg overflow-hidden border border-gray-300">
                            <input type="radio" id="male" name="gender" value="male" checked class="hidden" onchange="calculate()">
                            <label for="male" class="flex-1 text-center py-1.5 px-4 cursor-pointer text-gray-700 hover:bg-gray-50 text-sm">ç”·æ€§</label>
                            <input type="radio" id="female" name="gender" value="female" class="hidden" onchange="calculate()">
                            <label for="female" class="flex-1 text-center py-1.5 px-4 cursor-pointer text-gray-700 hover:bg-gray-50 text-sm">å¥³æ€§</label>
                        </div>
                    </div>

                    <!-- èº«é«˜, é«”é‡, å¹´é½¡ - ã€RWD ä¿®æ­£é»ã€‘åœ¨æ‰‹æ©Ÿä¸Šæ”¹ç‚ºå–®æ¬„å‚ç›´å †ç–Š (grid-cols-1) -->
                    <div class="grid grid-cols-1 gap-3 mb-4 text-xs md:grid-cols-3 input-group-stack">
                        <div><label for="height" class="block text-gray-600 font-medium mb-1">èº«é«˜ (cm)</label><input type="range" id="height" min="140" max="200" value="170" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateValue('height')" onchange="calculate()"><p class="text-center font-bold primary-color"><span id="height-val">170</span> cm</p></div>
                        <div><label for="weight" class="block text-gray-600 font-medium mb-1">é«”é‡ (kg)</label><input type="range" id="weight" min="40" max="150" value="70" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateValue('weight')" onchange="calculate()"><p class="text-center font-bold primary-color"><span id="weight-val">70</span> kg</p></div>
                        <div><label for="age" class="block text-gray-600 font-medium mb-1">å¹´é½¡ (æ­²)</label><input type="range" id="age" min="18" max="80" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateValue('age')" onchange="calculate()"><p class="text-center font-bold primary-color"><span id="age-val">30</span> æ­²</p></div>
                    </div>
                    
                    <!-- æ—¥å¸¸æ´»å‹•ç¨‹åº¦ -->
                    <div class="mb-4">
                        <label for="activity-level" class="block text-gray-600 mb-1 font-medium text-sm">æ—¥å¸¸æ´»å‹•ç¨‹åº¦</label>
                        <select id="activity-level" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="calculate()">
                            <option value="ä¹…åä¸å‹•">ä¹…åä¸å‹• (è¾¦å…¬å®¤å·¥ä½œ)</option>
                            <option value="è¼•åº¦æ´»å‹•">è¼•åº¦æ´»å‹• (ç«™ç«‹/è¼•å®¶å‹™)</option>
                            <option value="ä¸­åº¦æ´»å‹•" selected>ä¸­åº¦æ´»å‹• (æœå‹™æ¥­/è¦å¾‹èµ°å‹•)</option>
                            <option value="é«˜åº¦æ´»å‹•">é«˜åº¦æ´»å‹• (é«”åŠ›å‹å‹•/å»ºç¯‰)</option>
                            <option value="æ¥µåº¦æ´»å‹•">æ¥µåº¦æ´»å‹• (å°ˆæ¥­é‹å‹•è¨“ç·´)</option>
                        </select>
                    </div>

                    <!-- æ¯æ—¥é£²é£Ÿæ”å–é‡ -->
                    <div>
                        <label for="daily-intake" class="block text-gray-600 mb-1 font-medium text-sm">æ¯æ—¥é£²é£Ÿå¡è·¯é‡Œæ”å–é‡ (å¤§å¡)</label>
                        <input type="number" id="daily-intake" min="500" max="5000" value="2000" class="w-full p-2 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="calculate()" onblur="calculate()">
                        <p class="text-xs text-gray-500 mt-1">
                            ğŸ’¡ **åƒè€ƒéŒ¨é»ï¼š** å¥³æ€§ç´„ 1800 å¤§å¡ï¼›ç”·æ€§ç´„ 2200 å¤§å¡ã€‚
                        </p>
                    </div>
                </div>

                <!-- B. é‹å‹•è¨ˆåŠƒè¼¸å…¥ - ã€RWD ä¿®æ­£å€åŸŸã€‘è®“å…¶åœ¨æ‰‹æ©Ÿä¸Šè‡ªç„¶æµå‹•ï¼Œæ¡Œé¢å¡«æ»¿å‰©é¤˜é«˜åº¦ä¸¦å…§éƒ¨æ²å‹• -->
                <div id="input-exercise" class="card p-4 flex flex-col lg:flex-1 lg:overflow-hidden min-h-[250px]">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700 flex-shrink-0">B. é‹å‹•è¨ˆåŠƒæ¨¡æ“¬ (æ¯å¤©)</h2>
                    
                    <!-- é‹å‹•å¡ç‰‡åˆ—è¡¨ï¼šåœ¨æ‰‹æ©Ÿä¸Šæœƒè‡ªç„¶ä¼¸å±•ï¼Œåœ¨æ¡Œé¢ç«¯ (lg) æ‰æœƒå•Ÿç”¨å…§éƒ¨æ»¾å‹•å’Œé«˜åº¦å¡«æ»¿ -->
                    <!-- ä¿®æ­£: å¢åŠ  lg:h-0 ç¢ºä¿ Flexbox åœ¨ lg:flex-grow æ™‚æ­£ç¢ºè¨ˆç®—é«˜åº¦ï¼Œå•Ÿç”¨ overflow-y-auto -->
                    <div id="exercise-list" class="space-y-3 mb-3 pr-2 border-t border-gray-100 pt-3 min-h-[150px] lg:overflow-y-auto lg:flex-grow lg:h-0">
                        <!-- é‹å‹•å¡ç‰‡å°‡æœƒè¢« JS æ’å…¥é€™è£¡ -->
                    </div>

                    <!-- æŒ‰éˆ•ï¼šå›ºå®šåœ¨åº•éƒ¨ -->
                    <button onclick="addExerciseCard()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex-shrink-0">
                        (+) å¢åŠ é‹å‹•
                    </button>
                </div>

            </div>

            <!-- å³å´çµæœå ±è¡¨ - åœ¨æ‰‹æ©Ÿä¸Šè‡ªç„¶æµå‹•ï¼Œæ¡Œé¢ç«¯å…§éƒ¨æ²å‹• -->
            <div id="results" class="flex flex-col space-y-4 lg:h-full lg:overflow-y-auto">

                <!-- é—œéµæ•¸æ“šçµæœ -->
                <div class="card bg-blue-50 border-blue-200 flex-shrink-0">
                    <h2 class="text-lg font-semibold mb-3 text-blue-700">æ¯æ—¥è¨ˆç®—æ¦‚è¦</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-2 bg-white rounded-lg shadow-sm border border-blue-100">
                            <p class="text-xs text-gray-500">åŸºç¤ä»£è¬ç‡ (BMR)</p>
                            <p class="text-lg font-bold text-blue-800"><span id="bmr-val">0</span> å¤§å¡</p>
                        </div>
                        <div class="p-2 bg-white rounded-lg shadow-sm border border-blue-100">
                            <p class="text-xs text-gray-500">æ¯æ—¥ç¸½æ¶ˆè€— (TDEE)</p>
                            <p class="text-lg font-bold text-blue-800"><span id="tdee-val">0</span> å¤§å¡</p>
                        </div>
                    </div>
                    <div id="net-calorie-display" class="mt-3 p-3 rounded-lg text-center shadow-md">
                        <p class="text-sm font-semibold mb-1 text-gray-700">æ¯æ—¥æ·¨ç†±é‡ç›ˆè™§ (å¤§å¡)</p>
                        <p class="text-2xl font-extrabold"><span id="net-calorie-val">0</span> å¤§å¡</p>
                        
                        <!-- é«”é‡è®ŠåŒ–é¡¯ç¤º -->
                        <p class="mt-1 text-xs font-medium text-gray-600">
                            é è¨ˆæ¯å¤©é«”é‡
                            <span id="weight-direction-text" class="font-bold text-gray-700">è®ŠåŒ–</span>ï¼š
                            <span id="daily-weight-change-val" class="font-bold">0.000</span> å…¬æ–¤
                        </p>
                    </div>
                </div>

                <!-- å ±è¡¨ä¸€ï¼šç†±é‡å¹³è¡¡åˆ†æ - ã€RWD ä¿®æ­£å€åŸŸã€‘åœ¨æ‰‹æ©Ÿä¸Šç§»é™¤ flex-1 -->
                <div class="card lg:flex-1">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">å ±è¡¨ä¸€ï¼šç†±é‡å¹³è¡¡åˆ†æ (å¤§å¡)</h3>
                    <div class="relative h-64 lg:h-80">
                        <canvas id="calorieBalanceChart"></canvas>
                    </div>
                </div>

                <!-- å ±è¡¨äºŒï¼šé«”é‡è®ŠåŒ–è¶¨å‹¢ - ã€RWD ä¿®æ­£å€åŸŸã€‘åœ¨æ‰‹æ©Ÿä¸Šç§»é™¤ flex-1 -->
                <div class="card lg:flex-1">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">å ±è¡¨äºŒï¼šé è¨ˆé«”é‡è®ŠåŒ–è¶¨å‹¢ (12 é€±)</h3>
                    <p class="text-xs text-gray-500 mb-2">
                        ğŸ’¡ **è¿­ä»£æ¨¡æ“¬**ï¼šæ¯é€±çš„é«”é‡è®ŠåŒ–æœƒæ ¹æ“šæ‚¨ç•¶æ™‚çš„é«”é‡é‡æ–°è¨ˆç®— BMR å’Œé‹å‹•æ¶ˆè€—ï¼Œçµæœæ›´æ¥è¿‘ç¾å¯¦ã€‚
                    </p>
                    <div class="relative h-64 lg:h-80">
                        <canvas id="weightPredictionChart"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ADDED: Technical Specs Modal (Hidden by Default) (Fix 2) -->
    <div id="specs-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:max-w-4xl mx-auto p-6 md:p-10 transform transition-all duration-300 max-h-[90vh] overflow-y-auto relative">
            
            <!-- Close Button -->
            <button id="close-specs-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-800 rounded-full hover:bg-gray-100 transition">
                <!-- Lucide x icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">æŠ€è¡“è¦æ ¼ï¼šè¨ˆç®—æ¨¡å‹</h2>
            
            <div id="spec-content" class="prose max-w-none space-y-4">
                <!-- CONTENT CONVERTED FROM MD/LATEX TO HTML/MATHJAX -->
                <p>æœ¬æ¨¡å‹æ¡ç”¨ä¿®è¨‚ç‰ˆçš„ Harris-Benedict å…¬å¼è¨ˆç®—åŸºç¤ä»£è¬ç‡ (BMR)ï¼Œä¸¦çµåˆéé‹å‹•ç†±é‡æ¶ˆè€— (NEAT) å’Œé‹å‹•ç”Ÿç†± (TEA) è¨ˆç®—æ¯æ—¥ç¸½èƒ½é‡æ¶ˆè€— (TDEE)ã€‚</p>

                <h3 class="text-xl font-semibold mt-4">åŸºç¤ä»£è¬ç‡ (BMR)</h3>
                <p>å–®ä½ï¼šå¤§å¡/å¤© (kcal/day)</p>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p><strong>ç”·æ€§ (Men):</strong></p>
                    $$ \text{BMR} = 88.362 + (13.397 \times W) + (4.799 \times H) - (5.677 \times A) $$
                    <p><strong>å¥³æ€§ (Women):</strong></p>
                    $$ \text{BMR} = 447.593 + (9.247 \times W) + (3.098 \times H) - (4.330 \times A) $$
                    <p class="text-sm mt-2">å…¶ä¸­ï¼š<br>
                    $$ \text{W} = \text{é«”é‡ (å…¬æ–¤), } H = \text{èº«é«˜ (å…¬åˆ†), } A = \text{å¹´é½¡ (æ­²)} $$</p>
                </div>

                <h3 class="text-xl font-semibold mt-4">æ¯æ—¥ç¸½èƒ½é‡æ¶ˆè€— (TDEE)</h3>
                <p>$$ \text{TDEE } æ˜¯åŸºæ–¼ \text{ BMR}ã€éé‹å‹•æ´»å‹•å› å­ (\text{AF}_{NEAT}) å’Œæ¯æ—¥é‹å‹•æ¶ˆè€—çš„ç¸½å’Œã€‚ $$</p>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    $$ \text{TDEE} = (\text{BMR} \times \text{AF}_{NEAT}) + \text{æ¯æ—¥é‹å‹•æ¶ˆè€—} $$
                    <p class="text-sm mt-2">å…¶ä¸­ï¼š<br>
                    $$ \text{AF}_{NEAT} = \text{éé‹å‹•æ´»å‹•å› å­ (å¾è¼¸å…¥çš„æ´»å‹•æ°´å¹³æ±ºå®š)} $$</p>
                    <ul class="list-disc ml-6 mt-2 text-sm space-y-1">
                        <li>ä¹…åä¸å‹• (Sedentary): $$\text{AF}_{NEAT} = 1.2$$</li>
                        <li>è¼•åº¦æ´»å‹• (Lightly Active): $$\text{AF}_{NEAT} = 1.375$$</li>
                        <li>ä¸­åº¦æ´»å‹• (Moderately Active): $$\text{AF}_{NEAT} = 1.55$$</li>
                        <li>é«˜åº¦æ´»å‹• (Very Active): $$\text{AF}_{NEAT} = 1.725$$</li>
                        <li>æ¥µåº¦æ´»å‹• (Extra Active): $$\text{AF}_{NEAT} = 1.9$$</li>
                    </ul>
                </div>

                <h3 class="text-xl font-semibold mt-4">é«”é‡è¶¨å‹¢é æ¸¬</h3>
                <p>é«”é‡è®ŠåŒ–åŸºæ–¼ç†±é‡ç›ˆé¤˜æˆ–èµ¤å­—ï¼Œç´„ 7700 å¤§å¡ï¼ˆkcalï¼‰ç­‰æ–¼ 1 å…¬æ–¤ï¼ˆkgï¼‰é«”é‡è®ŠåŒ–ã€‚è¨ˆç®—æœƒæ ¹æ“šé«”é‡è®ŠåŒ–ï¼Œæ¯å¤©é‡æ–°è¨ˆç®—æ–°çš„ BMR å’Œ TDEEã€‚</p>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    $$ \text{æ¯æ—¥å¡è·¯é‡Œå·®ç•°} (\text{kcal}) = \text{æ¯æ—¥æ”å–} - \text{TDEE} $$
                    $$ \text{æ¯æ—¥é«”é‡è®ŠåŒ–} (\text{kg}) \approx \frac{\text{æ¯æ—¥å¡è·¯é‡Œå·®ç•°}}{7700} $$
                </div>
            </div>

        </div>
    </div>

    <script>
        // METs æ•¸æ“šè¡¨æ ¼ (ç¡¬ç·¨ç¢¼)
        const METS_DATA = {
            "è·‘æ­¥": [
                { "å¼·åº¦": "æ…¢è·‘ (ç´„ 8 km/h)", "METs": 8.0 },
                { "å¼·åº¦": "ä¸­é€Ÿè·‘ (ç´„ 10 km/h)", "METs": 10.0 },
                { "å¼·åº¦": "è¡åˆºè·‘ (ç´„ 12 km/h ä»¥ä¸Š)", "METs": 12.5 }
            ],
            "æ¸¸æ³³": [
                { "å¼·åº¦": "è¼•é‡/ä¼‘é–’å¼æ¸¸æ³³", "METs": 6.0 },
                { "å¼·åº¦": "åŠ‡çƒˆ/è¨“ç·´å¼æ¸¸æ³³", "METs": 10.0 }
            ],
            "å–®è»Š": [
                { "å¼·åº¦": "è¼•åº¦ (ç´„ 16 km/h)", "METs": 6.8 },
                { "å¼·åº¦": "ä¸­åº¦ (ç´„ 20-25 km/h)", "METs": 10.0 },
                { "å¼·åº¦": "åŠ‡çƒˆ (ç´„ 30 km/h ä»¥ä¸Š)", "METs": 14.0 }
            ],
            "å¥è¡Œ": [
                { "å¼·åº¦": "å¹³åœ°å¿«èµ°/å¥è¡Œ", "METs": 4.5 },
                { "å¼·åº¦": "çˆ¬å¡å¥è¡Œ", "METs": 6.0 }
            ],
            "è‚ŒåŠ›è¨“ç·´": [
                { "å¼·åº¦": "è¼•åº¦åŠªåŠ›", "METs": 3.5 },
                { "å¼·åº¦": "ä¸­åº¦åŠªåŠ› (ä¸€èˆ¬è¨“ç·´)", "METs": 5.0 },
                { "å¼·åº¦": "åŠ‡çƒˆåŠªåŠ› (é«˜å¼·åº¦)", "METs": 8.0 }
            ],
            "æ—¥å¸¸æ´»å‹•": [
                { "å¼·åº¦": "å®¶å‹™æ¸…æ½” (æ‹–åœ°ã€å¸å¡µ)", "METs": 3.3 },
                { "å¼·åº¦": "å¿«æ­¥èµ° (è³¼ç‰©ã€é€šå‹¤)", "METs": 3.5 },
                { "å¼·åº¦": "çˆ¬æ¨“æ¢¯ (ä¸€èˆ¬é€Ÿåº¦)", "METs": 4.0 }
            ]
        };

        const ACTIVITY_FACTORS = {
            "ä¹…åä¸å‹•": 1.2,
            "è¼•åº¦æ´»å‹•": 1.375,
            "ä¸­åº¦æ´»å‹•": 1.55,
            "é«˜åº¦æ´»å‹•": 1.725,
            "æ¥µåº¦æ´»å‹•": 1.9
        };

        // åœ–è¡¨å¯¦ä¾‹
        let calorieBalanceChart = null;
        let weightPredictionChart = null;
        let exerciseCardCount = 0;

        // --- æ ¸å¿ƒè¨ˆç®—å‡½å¼ ---

        /**
         * è¨ˆç®—åŸºç¤ä»£è¬ç‡ (BMR) - Mifflin-St Jeor Equation
         */
        function calculateBMR(gender, weight_kg, height_cm, age_years) {
            let bmr = (10 * weight_kg) + (6.25 * height_cm) - (5 * age_years);
            if (gender === 'male') {
                bmr += 5;
            } else { // female
                bmr -= 161;
            }
            return Math.round(bmr);
        }

        /**
         * è¨ˆç®—æ¯æ—¥ç¸½ç†±é‡æ¶ˆè€— (TDEE)
         */
        function calculateTDEE(bmr, activity_level) {
            const factor = ACTIVITY_FACTORS[activity_level] || 1.2;
            return Math.round(bmr * factor);
        }

        /**
         * è¨ˆç®—é‹å‹•ç†±é‡æ¶ˆè€— (METs å…¬å¼)
         */
        function calculateExerciseBurn(mets, weight_kg, time_min) {
            // Calories Burned = (METs * 3.5 * W) / 200 * T
            if (time_min <= 0 || mets <= 0) return 0;
            const burn = (mets * 3.5 * weight_kg) / 200 * time_min;
            return Math.round(burn);
        }

        /**
         * é«”é‡è®ŠåŒ–è¨ˆç®—
         * @param {number} net_calorie_change - æ·¨ç†±é‡è®ŠåŒ– (æ”å– - æ¶ˆè€—)ï¼Œæ­£æ•¸ç‚ºç›ˆé¤˜ (å¢é‡)ï¼Œè² æ•¸ç‚ºè™§æ (æ¸›é‡)
         */
        function calculateWeightChange(net_calorie_change) {
            // 1 å…¬æ–¤è„‚è‚ªç´„ = 7700 å¤§å¡
            const change_kg = net_calorie_change / 7700;
            return parseFloat(change_kg.toFixed(4)); // è¿”å›æµ®é»æ•¸ (æ­£æ•¸ç‚ºå¢åŠ ï¼Œè² æ•¸ç‚ºæ¸›å°‘)
        }

        // --- UI äº’å‹•å‡½å¼ ---

        /**
         * æ›´æ–° Slider çš„æ•¸å€¼é¡¯ç¤º
         */
        function updateValue(id) {
            const slider = document.getElementById(id);
            const valEl = document.getElementById(id + '-val');
            if (slider && valEl) valEl.innerText = slider.value;
        }

        /**
         * è™•ç†é‹å‹•é¡å‹è®ŠåŒ–ï¼Œæ›´æ–°å¼·åº¦é¸é …
         */
        function updateIntensityOptions(cardId) {
            const typeSelect = document.getElementById(`exercise-type-${cardId}`);
            const intensitySelect = document.getElementById(`exercise-intensity-${cardId}`);
            
            if (!typeSelect || !intensitySelect) return;

            const selectedType = typeSelect.value;
            
            // æ¸…ç©ºèˆŠé¸é …
            intensitySelect.innerHTML = '';
            
            if (METS_DATA[selectedType]) {
                METS_DATA[selectedType].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.METs;
                    option.textContent = item.å¼·åº¦;
                    intensitySelect.appendChild(option);
                });
            }

            // è§¸ç™¼é‡æ–°è¨ˆç®—
            calculate();
        }

        /**
         * å¢åŠ é‹å‹•å¡ç‰‡
         */
        function addExerciseCard() {
            exerciseCardCount++;
            const id = exerciseCardCount;
            const list = document.getElementById('exercise-list');
            
            if (!list) return;

            const newCard = document.createElement('div');
            newCard.id = `exercise-card-${id}`;
            newCard.className = 'card p-3 border border-blue-200 bg-white shadow-md relative';
            newCard.innerHTML = `
                <button onclick="removeExerciseCard(${id})" class="absolute top-1 right-1 text-red-500 hover:text-red-700 transition duration-150" aria-label="ç§»é™¤é‹å‹•">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                </button>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-0.5 font-medium text-xs">é‹å‹•é¡å‹</label>
                    <select id="exercise-type-${id}" class="w-full p-1.5 text-xs border border-gray-300 rounded-lg" onchange="updateIntensityOptions(${id})">
                        ${Object.keys(METS_DATA).map(type => `<option value="${type}">${type}</option>`).join('')}
                    </select>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-0.5 font-medium text-xs">é‹å‹•å¼·åº¦</label>
                    <select id="exercise-intensity-${id}" class="w-full p-1.5 text-xs border border-gray-300 rounded-lg" onchange="calculate()">
                        <!-- é¸é …ç”± JS å¡«å…… -->
                    </select>
                </div>
                <div>
                    <label for="exercise-time-${id}" class="block text-gray-600 font-medium mb-0.5 text-xs">æ¯å¤©é‹å‹•æ™‚é–“ (åˆ†é˜)</label>
                    <input type="range" id="exercise-time-${id}" min="0" max="120" step="10" value="30" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateTimeValue(${id})" onchange="calculate()">
                    <p class="text-center text-xs font-bold text-blue-600"><span id="exercise-time-val-${id}">30</span> åˆ†é˜</p>
                </div>
            `;
            list.appendChild(newCard);
            
            // åˆå§‹åŒ–å¼·åº¦é¸é …
            updateIntensityOptions(id);
            // åœ¨æ‰‹æ©Ÿç‰ˆæ™‚ï¼Œåˆ—è¡¨æ²å‹•åˆ°åº•éƒ¨ï¼Œç¢ºä¿æ–°å¡ç‰‡å¯è¦‹
            if (window.innerWidth < 1024) {
                 // åœ¨æ‰‹æ©Ÿä¸Šï¼Œè®“æ•´å€‹ body æ²å‹•ï¼Œè€Œä¸æ˜¯å…§éƒ¨åˆ—è¡¨
            } else {
                 list.scrollTop = list.scrollHeight;
            }
        }

        /**
         * ç§»é™¤é‹å‹•å¡ç‰‡
         */
        function removeExerciseCard(id) {
            const card = document.getElementById(`exercise-card-${id}`);
            if (card) card.remove();
            calculate();
        }

        /**
         * æ›´æ–°é‹å‹•æ™‚é–“ Slider æ•¸å€¼
         */
        function updateTimeValue(id) {
             const slider = document.getElementById(`exercise-time-${id}`);
             const valEl = document.getElementById(`exercise-time-val-${id}`);
             if (slider && valEl) valEl.innerText = slider.value;
        }

        // --- åœ–è¡¨ç¹ªè£½å‡½å¼ ---

        /**
         * ç¹ªè£½ç†±é‡å¹³è¡¡åœ– (Stacked Bar Chart)
         */
        function drawCalorieBalanceChart(bmr, nonBmrBurn, totalExerciseBurn, dailyIntake) {
            const canvas = document.getElementById('calorieBalanceChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (calorieBalanceChart) {
                calorieBalanceChart.destroy();
            }

            calorieBalanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ç†±é‡åˆ†æ'],
                    datasets: [
                        { label: 'é£²é£Ÿæ”å–', data: [dailyIntake], backgroundColor: '#ef4444' }, 
                        { label: 'åŸºç¤ä»£è¬ (BMR)', data: [-bmr], backgroundColor: '#99f6e4' },
                        { label: 'æ—¥å¸¸æ´»å‹•æ¶ˆè€—', data: [-nonBmrBurn], backgroundColor: '#34d399' },
                        { label: 'é‹å‹•æ¶ˆè€—', data: [-totalExerciseBurn], backgroundColor: '#10b981' },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true, 
                            title: { display: true, text: 'å¤§å¡ (Kcal)' }
                        }
                    },
                    plugins: { legend: { position: 'top' }, title: { display: false } }
                }
            });
        }

        /**
         * ç¹ªè£½é«”é‡è®ŠåŒ–è¶¨å‹¢åœ– (Line Chart) - å·²ä¿®æ­£ç‚ºè¿­ä»£è¨ˆç®—
         * æ¯æ¬¡è¨ˆç®—éƒ½ä½¿ç”¨ä¸Šä¸€é€±çµæŸæ™‚çš„é«”é‡ä¾†é‡æ–°è¨ˆç®— BMR å’Œé‹å‹•æ¶ˆè€—ã€‚
         */
        function drawWeightPredictionChart(gender, height_cm, age_years, activity_level, initialWeight, initialTotalExerciseBurn, dailyIntake) {
            const canvas = document.getElementById('weightPredictionChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const weeks = 12; 
            // æ¨™ç±¤åŒ…å«ç¬¬ 0 é€± (èµ·å§‹) åˆ° ç¬¬ 12 é€± (çµæŸ)
            const labels = Array.from({ length: weeks + 1 }, (_, i) => `ç¬¬ ${i} é€±`);
            const weightData = [];
            
            // é€™æ˜¯åˆå§‹é«”é‡ï¼Œä¹Ÿæ˜¯ç¬¬ 0 é€±çš„é«”é‡
            let currentWeight = initialWeight;
            const initialWeightVal = initialWeight; // å„²å­˜åˆå§‹é«”é‡ç”¨æ–¼æ¯”ä¾‹è¨ˆç®—

            let predictedMin = initialWeight;
            let predictedMax = initialWeight;

            // 1. è¨˜éŒ„ç¬¬ 0 é€± (èµ·å§‹) é«”é‡
            weightData.push(currentWeight.toFixed(2));

            // 2. è¿­ä»£è¨ˆç®— 1 åˆ° 12 é€±çš„é«”é‡
            for (let i = 1; i <= weeks; i++) { 
                
                const weekStartWeight = currentWeight; // é€™å°±æ˜¯ä¸Šä¸€é€±çµæŸæ™‚çš„é«”é‡

                // 2.1. æ ¹æ“šç•¶å‰é«”é‡é‡æ–°è¨ˆç®— BMR å’Œ TDEE
                const bmr_i = calculateBMR(gender, weekStartWeight, height_cm, age_years);
                const tdee_i = calculateTDEE(bmr_i, activity_level);

                // 2.2. æ ¹æ“šç•¶å‰é«”é‡é‡æ–°è¨ˆç®—é‹å‹•æ¶ˆè€— (å‡è¨­ METs å’Œæ™‚é–“ä¸è®Šï¼Œæ¶ˆè€—èˆ‡é«”é‡æˆæ­£æ¯”: E_i = E_0 * (W_i / W_0))
                let exerciseBurn_i = 0;
                // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨åˆå§‹é‹å‹•æ¶ˆè€— * (ç•¶å‰é«”é‡ / åˆå§‹é«”é‡) ä¾†è¿‘ä¼¼æ–°çš„é‹å‹•æ¶ˆè€—
                if (initialWeightVal > 0) {
                   exerciseBurn_i = initialTotalExerciseBurn * (weekStartWeight / initialWeightVal);
                }

                // 2.3. è¨ˆç®—æ¯æ—¥ç¸½æ¶ˆè€—å’Œæ·¨ç†±é‡ç›ˆè™§
                const totalOut_i = tdee_i + exerciseBurn_i;
                const netCalorie_i = dailyIntake - totalOut_i; 
                
                // 2.4. è¨ˆç®—ä¸€é€±çš„é«”é‡è®ŠåŒ–
                const dailyWeightChange_i = calculateWeightChange(netCalorie_i);
                const weightChange_week = dailyWeightChange_i * 7;
                
                let predictedWeight = weekStartWeight + weightChange_week;
                
                // 2.5. æ›´æ–°ä¸‹ä¸€è¼ªçš„é«”é‡ï¼Œä¸¦è¨˜éŒ„æœ¬é€±çµæŸçš„é«”é‡
                currentWeight = predictedWeight;
                weightData.push(currentWeight.toFixed(2));

                if (predictedWeight < predictedMin) predictedMin = predictedWeight;
                if (predictedWeight > predictedMax) predictedMax = predictedWeight;
            }

            // --- å„ªåŒ–å¾Œçš„ Y è»¸å‹•æ…‹ç¯„åœè¨ˆç®—é‚è¼¯ ---
            const W_min = predictedMin;
            const W_max = predictedMax;

            // 1. ç¢ºå®šç›®æ¨™ä¸­å¿ƒé» (W_mid)
            const W_mid = (W_min + W_max) / 2;

            // 2. ç¢ºå®šè»¸ç·šç¸½ç¯„åœ (AxisRange)
            const dataRange = W_max - W_min;
            const padding = 2.0; // 2 kg ç·©è¡
            const MVR = 10.0;    // æœ€å°å¯è¦–ç¯„åœæ˜¯ 10 kg (ä»¥ç¢ºä¿è¦–è¦ºæ–œç‡)

            const AxisRange = Math.max(dataRange + padding, MVR);

            // 3. ç¢ºå®šæœ€çµ‚çš„ Y è»¸ä¸Šä¸‹é™
            let yAxisMin = W_mid - (AxisRange / 2);
            let yAxisMax = W_mid + (AxisRange / 2);

            // ç¢ºä¿æœ€å°å€¼ä¸æœƒè®“åœ–è¡¨çœ‹èµ·ä¾†å¾ˆæ“  (å‘ä¸‹å–æ•´è‡³ 5 çš„å€æ•¸ï¼Œè®“è»¸ç·šæ›´æ•´æ½”)
            yAxisMin = Math.floor(yAxisMin / 5) * 5;
            yAxisMax = Math.ceil(yAxisMax / 5) * 5;
            // é¿å… Y è»¸ç¯„åœéå°ï¼Œå³ä½¿å››æ¨äº”å…¥å¾Œï¼Œä¹Ÿè¦ç¢ºä¿ AxisRange è‡³å°‘ç‚º MVR
            if (yAxisMax - yAxisMin < MVR) {
                 yAxisMax = yAxisMin + MVR;
            }
            // --- çµæŸ Y è»¸å‹•æ…‹ç¯„åœè¨ˆç®—é‚è¼¯ ---


            if (weightPredictionChart) {
                weightPredictionChart.destroy();
            }

            // åˆ¤æ–·ç·šæ¢é¡è‰²ï¼šä½¿ç”¨åˆå§‹è¨ˆç®—çš„ dailyWeightChange (æ·¨ç†±é‡ç›ˆè™§) ä¾†åˆ¤æ–·è¶¨å‹¢é¡è‰²
            const initialBmr = calculateBMR(gender, initialWeight, height_cm, age_years);
            const initialTdee = calculateTDEE(initialBmr, activity_level);
            const initialNetCalorie = dailyIntake - (initialTdee + initialTotalExerciseBurn);
            
            // å¢é‡ (æ­£æ•¸) ç”¨ç´…è‰²ï¼Œæ¸›é‡ (è² æ•¸) ç”¨ç¶ è‰²ï¼Œå¹³è¡¡ç”¨è—è‰²
            const lineColor = initialNetCalorie > 0.001 ? '#ef4444' : (initialNetCalorie < -0.001 ? '#10b981' : '#3b82f6');


            weightPredictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é è¨ˆé«”é‡ (kg)',
                        data: weightData,
                        borderColor: lineColor,
                        backgroundColor: lineColor + '33',
                        tension: 0.3,
                        pointRadius: 4, 
                        pointHoverRadius: 6,
                        pointBackgroundColor: lineColor,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: yAxisMin, 
                            max: yAxisMax, 
                            title: { display: true, text: 'é«”é‡ (kg)' }
                        }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }


        /**
         * ä¸»è¨ˆç®—å‡½æ•¸ï¼šè®€å–æ‰€æœ‰è¼¸å…¥ä¸¦æ›´æ–°çµæœ
         */
        function calculate() {
            // 1. è®€å– BMC è¼¸å…¥
            const gender = document.querySelector('input[name="gender"]:checked')?.value || 'male';
            const height_cm = parseFloat(document.getElementById('height')?.value || 170);
            const weight_kg = parseFloat(document.getElementById('weight')?.value || 70);
            const age_years = parseFloat(document.getElementById('age')?.value || 30);
            const activity_level = document.getElementById('activity-level')?.value || 'ä¸­åº¦æ´»å‹•';
            
            // è™•ç†æ¯æ—¥é£²é£Ÿæ”å–é‡ 
            let daily_intake_input = document.getElementById('daily-intake');
            let daily_intake = parseFloat(daily_intake_input?.value || 2000);

            // ç¢ºä¿å€¼åœ¨æœ‰æ•ˆç¯„åœå…§
            if (isNaN(daily_intake) || daily_intake < 500) {
                daily_intake = 500;
            } else if (daily_intake > 5000) {
                daily_intake = 5000;
            }
            if (parseFloat(daily_intake_input.value) !== daily_intake) {
                 daily_intake_input.value = daily_intake;
            }

            // 2. æ ¸å¿ƒè¨ˆç®— (åŸºæ–¼ç•¶å‰è¼¸å…¥çš„é«”é‡)
            const bmr = calculateBMR(gender, weight_kg, height_cm, age_years);
            const bmrEl = document.getElementById('bmr-val');
            if (bmrEl) bmrEl.innerText = bmr;

            const tdee = calculateTDEE(bmr, activity_level);
            const tdeeEl = document.getElementById('tdee-val');
            if (tdeeEl) tdeeEl.innerText = tdee;

            // æ—¥å¸¸æ´»å‹•æ¶ˆè€— (ä¸å« BMR) - ç”¨æ–¼åœ–è¡¨
            const nonBmrBurn = tdee - bmr;

            // 3. é‹å‹•è¨ˆåŠƒè¨ˆç®— (åŸºæ–¼ç•¶å‰è¼¸å…¥çš„é«”é‡)
            let totalExerciseBurn = 0;
            const exerciseCards = document.querySelectorAll('#exercise-list > div');
            
            exerciseCards.forEach(card => {
                const id = card.id.split('-')[2];
                const metsEl = document.getElementById(`exercise-intensity-${id}`);
                const timeEl = document.getElementById(`exercise-time-${id}`);
                
                if (metsEl && timeEl) {
                    const mets = parseFloat(metsEl.value);
                    const time_min = parseFloat(timeEl.value);
                    const burn = calculateExerciseBurn(mets, weight_kg, time_min);
                    totalExerciseBurn += burn;
                }
            });

            // 4. æ·¨ç†±é‡ç›ˆè™§è¨ˆç®— (ç›ˆé¤˜ç‚ºæ­£ï¼Œè™§æç‚ºè² )
            // ç¸½æ¶ˆè€— = TDEE (åŸºç¤+æ´»å‹•) + é¡å¤–é‹å‹•æ¶ˆè€—
            const totalOut = tdee + totalExerciseBurn;
            const netCalorie = daily_intake - totalOut; 
            const dailyWeightChange = calculateWeightChange(netCalorie);
            
            // 5. æ›´æ–°çµæœé¡¯ç¤ºå€
            const netCalorieDisplay = document.getElementById('net-calorie-display');
            const netCalorieValEl = document.getElementById('net-calorie-val');
            const dailyWeightChangeValEl = document.getElementById('daily-weight-change-val');
            const weightDirectionTextEl = document.getElementById('weight-direction-text');

            if (netCalorieValEl) netCalorieValEl.innerText = netCalorie.toLocaleString('en', {signDisplay: 'always'});
            if (dailyWeightChangeValEl) dailyWeightChangeValEl.innerText = Math.abs(dailyWeightChange).toFixed(3);

            // é¡è‰²å’Œæ–‡å­—æç¤º
            if (netCalorieDisplay && weightDirectionTextEl) { 
                if (netCalorie > 0) {
                    netCalorieDisplay.className = 'mt-3 p-3 rounded-lg shadow-md bg-red-100 border border-red-300 text-center';
                    if (netCalorieValEl) {
                        netCalorieValEl.classList.remove('text-green-600');
                        netCalorieValEl.classList.add('text-red-600');
                    }
                    weightDirectionTextEl.innerText = `å¢åŠ `;
                    weightDirectionTextEl.classList.add('text-red-600');
                    weightDirectionTextEl.classList.remove('text-green-600', 'text-gray-700');
                } else if (netCalorie < 0) {
                    netCalorieDisplay.className = 'mt-3 p-3 rounded-lg shadow-md bg-green-100 border border-green-300 text-center';
                    if (netCalorieValEl) {
                        netCalorieValEl.classList.remove('text-red-600');
                        netCalorieValEl.classList.add('text-green-600');
                    }
                    weightDirectionTextEl.innerText = `æ¸›å°‘`;
                    weightDirectionTextEl.classList.add('text-green-600');
                    weightDirectionTextEl.classList.remove('text-red-600', 'text-gray-700');
                } else {
                    netCalorieDisplay.className = 'mt-3 p-3 rounded-lg shadow-md bg-gray-100 border border-gray-300 text-center';
                    if (netCalorieValEl) netCalorieValEl.classList.remove('text-red-600', 'text-green-600');
                    weightDirectionTextEl.innerText = `ç„¡è®ŠåŒ–`;
                    weightDirectionTextEl.classList.add('text-gray-700');
                    weightDirectionTextEl.classList.remove('text-red-600', 'text-green-600');
                }
            }

            // 6. ç¹ªè£½åœ–è¡¨
            drawCalorieBalanceChart(bmr, nonBmrBurn, totalExerciseBurn, daily_intake);
            
            // ä½¿ç”¨æ‰€æœ‰åƒæ•¸é€²è¡Œè¿­ä»£è¨ˆç®—çš„ç¹ªåœ–
            drawWeightPredictionChart(
                gender, 
                height_cm, 
                age_years, 
                activity_level, 
                weight_kg, 
                totalExerciseBurn, // åˆå§‹é«”é‡ä¸‹çš„é‹å‹•æ¶ˆè€—
                daily_intake
            );
        }

        // --- Modal & MathJax Handling Logic (ADDED) ---
        const openSpecsBtn = document.getElementById('open-specs-btn');
        const closeSpecsBtn = document.getElementById('close-specs-btn');
        const specsModal = document.getElementById('specs-modal');
        const specContent = document.getElementById('spec-content');

        /**
         * Opens the modal and triggers MathJax rendering for formulas.
         */
        if (openSpecsBtn) {
            openSpecsBtn.addEventListener('click', () => {
                specsModal.classList.remove('hidden');
                
                // Crucial: Wait for the next frame to ensure the element is visible 
                // before telling MathJax to typeset it.
                window.requestAnimationFrame(() => {
                    if (window.MathJax) {
                        // Use MathJax.typesetPromise to ensure rendering completes
                        MathJax.typesetPromise([specContent]).then(() => {
                            console.log("MathJax typeset successfully completed.");
                        }).catch((err) => {
                            console.error("MathJax typeset error:", err);
                        });
                    } else {
                        console.warn("MathJax is not loaded. Formulas will not render.");
                    }
                });
            });
        }

        /**
         * Closes the modal.
         */
        if (closeSpecsBtn) {
            closeSpecsBtn.addEventListener('click', () => {
                specsModal.classList.add('hidden');
            });
        }
        
        // Close modal when clicking outside (on the backdrop)
        if (specsModal) {
            specsModal.addEventListener('click', (e) => {
                if (e.target === specsModal) {
                    specsModal.classList.add('hidden');
                }
            });
        }

        // --- åˆå§‹åŒ– ---

        window.onload = function() {
            // åˆå§‹åŒ– Slider é¡¯ç¤ºå€¼
            updateValue('height');
            updateValue('weight');
            updateValue('age');

            // åˆå§‹æ™‚å¢åŠ ä¸€å¼µé‹å‹•å¡ç‰‡
            addExerciseCard(); 

            // åˆå§‹è¨ˆç®—
            calculate();

            // ç¢ºä¿ Chart.js çŸ¥é“å¦‚ä½•è™•ç†é«˜åº¦è®ŠåŒ– (åœ¨æ¡Œé¢æ¨¡å¼ä¸‹æœƒéœ€è¦)
            window.addEventListener('resize', () => {
                if (calorieBalanceChart) calorieBalanceChart.resize();
                if (weightPredictionChart) weightPredictionChart.resize();
            });
        };

    </script>
</body>
</html>